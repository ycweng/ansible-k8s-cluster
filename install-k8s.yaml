---
- name: install k8s lib
  hosts:
    - "{{ uat_group | default('server') }}"
  tasks:
    - name: "basic package"
      shell: |
       systemctl stop firewalld
       systemctl disable firewalld
       dnf remove docker-ce -y
       yum install -y yum-utils glusterfs-client glusterfs-fuse iproute-tc lvm2 nfs-utils

      register: msg
    - name:
      debug:
        msg: "{{ msg }}"

    - name: "install docker"
      shell: |
        yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo                                                                                    
        yum install -y docker-ce-20.10.17-3.el8 docker-ce-cli-20.10.17-3.el8 containerd.io docker-compose-plugin                                                                 
        mkdir -p /etc/docker/
        touch /etc/docker/daemon.json
        cat <<EOF > /etc/docker/daemon.json
        {
          "exec-opts": ["native.cgroupdriver=systemd"],
          "log-driver": "json-file",
          "log-opts": {
            "max-size": "1m",
            "max-file": "5"
          },
          "storage-driver": "overlay2"
        }
        EOF
      register: msg
    - name:
      debug:
        msg: "{{ msg }}"

    - name: "modify swap"
      shell: |
        swap_config=$(cat /etc/fstab |grep swap)
        swapoff -a
        sed -i "s|$swap_config|# $swap_config|" /etc/fstab
        systemctl daemon-reload
      register: msg
    - name:
      debug:
        msg: "{{ msg }}"

    - name: "install k8s"
      shell: |
        cat <<EOF > /etc/yum.repos.d/kubernetes.repo
        [kubernetes]
        name=Kubernetes
        baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
        enabled=1
        gpgcheck=1
        repo_gpgcheck=1
        gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
        exclude=kubelet kubeadm kubectl
        EOF
        
        yum install -y kubelet-1.23.2 kubeadm-1.23.2 kubectl-1.23.2 --disableexcludes=kubernetes

      register: msg
    - name:
      debug:
        msg: "{{ msg }}"

    - name: "modify iptable"
      shell: |
        modprobe ip_tables
        modprobe iptable_filter
        modprobe br_netfilter
        
        cat <<EOF > /etc/modules-load.d/istio-iptables.conf
        ip_tables
        iptable_filter
        br_netfilter
        EOF
        
        systemctl restart systemd-modules-load.service
        
        cat <<EOF >  /etc/sysctl.d/k8s.conf
        net.bridge.bridge-nf-call-ip6tables = 1
        net.bridge.bridge-nf-call-iptables = 1
        net.ipv4.ip_nonlocal_bind = 1
        net.ipv4.ip_forward = 1
        vm.swappiness=0
        EOF
        
        sysctl -p
        sysctl --system
      register: msg
    - name:
      debug:
        msg: "{{ msg }}"

    - name: "start service"
      shell: |
        systemctl daemon-reload
        systemctl enable --now kubelet
        systemctl enable --now docker
        systemctl restart docker
        systemctl show --property=Environment docker
        systemctl status docker
      register: msg
    - name:
      debug:
        msg: "{{ msg }}"